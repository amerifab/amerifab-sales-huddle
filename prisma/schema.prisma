// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  password       String
  name           String
  role           String          @default("REP") // REP, MANAGER, ADMIN
  createdAt      DateTime        @default(now())
  insights       Insight[]
  reminders      Reminder[]
  microsoftToken MicrosoftToken?
}

model Customer {
  id               String     @id @default(cuid())
  name             String
  parentCompany    String?    // Corporate parent (e.g., "Nucor", "SDI") - displays as "Parent - Name"
  location         String?
  contact          String?
  rep              String?
  type             String     @default("Key Account") // Key Account, Growth, Prospect
  notes            String?
  revenue          Float?     // Annual revenue in dollars
  story            String?    // AI-generated "Whole Story" narrative
  storyGeneratedAt DateTime?  // When the story was last generated
  insights         Insight[]
  reminders        Reminder[]
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

model Insight {
  id         String     @id @default(cuid())
  type       String     // context, need, action, dossier
  content    String
  rep        String?
  date       DateTime   @default(now())
  customerId String
  customer   Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdBy  String?
  user       User?      @relation(fields: [createdBy], references: [id])
  reminders  Reminder[]
}

model Reminder {
  id             String    @id @default(cuid())
  title          String
  description    String?
  dueDate        DateTime?
  dollarAmount   Float?
  reminderType   String    // follow_up, deadline, meeting, quote_expiry, payment_due, general
  status         String    @default("pending") // pending, sent, completed, cancelled
  outlookEventId String?
  calendarSynced Boolean   @default(false)
  emailSentAt    DateTime?
  emailMessageId String?
  insightId      String
  insight        Insight   @relation(fields: [insightId], references: [id], onDelete: Cascade)
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  customerId     String
  customer       Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId, status])
  @@index([dueDate])
  @@index([customerId])
}

model MicrosoftToken {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String   @db.Text
  refreshToken String   @db.Text
  expiresAt    DateTime
  scope        String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
